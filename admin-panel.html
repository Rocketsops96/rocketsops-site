<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VVO - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-red: #DC143C;
            --dark-red: #B22222;
            --white: #FFFFFF;
            --light-gray: #F8F8F8;
            --dark-gray: #1a1a1a;
            --text-gray: #666666;
        }

        /* Dark theme (wie Hauptseite) */
        [data-theme="dark"] {
            --white: #1a1a1a;
            --light-gray: #2a2a2a;
            --dark-gray: #f0f0f0;
            --text-gray: #b0b0b0;
        }

        [data-theme="dark"] body {
            background: #1a1a1a;
            color: var(--dark-gray);
        }

        [data-theme="dark"] .admin-header {
            background: var(--light-gray);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .admin-current-user {
            color: var(--dark-gray);
            background: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .admin-tabs {
            background: var(--light-gray);
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .admin-tab {
            color: var(--text-gray);
        }

        [data-theme="dark"] .admin-tab:hover,
        [data-theme="dark"] .admin-tab.active {
            color: var(--primary-red);
        }

        [data-theme="dark"] .upload-section,
        [data-theme="dark"] .news-section,
        [data-theme="dark"] .news-form,
        [data-theme="dark"] .users-form,
        [data-theme="dark"] .users-list,
        [data-theme="dark"] .stats-chart-wrap,
        [data-theme="dark"] .gallery-preview,
        [data-theme="dark"] .messages-section,
        [data-theme="dark"] .section-order-item {
            background: var(--light-gray) !important;
            color: var(--dark-gray);
            border-color: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .upload-section h2,
        [data-theme="dark"] .news-section h2,
        [data-theme="dark"] .stats-section h2,
        [data-theme="dark"] .stats-chart-wrap h3 {
            color: var(--dark-gray);
        }

        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea,
        [data-theme="dark"] .editor-content {
            background: var(--white) !important;
            color: var(--dark-gray);
            border-color: rgba(255, 255, 255, 0.15);
        }

        [data-theme="dark"] .news-item,
        [data-theme="dark"] .message-item,
        [data-theme="dark"] .user-row {
            border-color: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .stat-card {
            background: var(--light-gray);
            border-color: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .stat-card-value {
            color: var(--primary-red);
        }

        [data-theme="dark"] .stat-card-label,
        [data-theme="dark"] .user-meta,
        [data-theme="dark"] .users-hint {
            color: var(--text-gray);
        }

        [data-theme="dark"] .upload-area {
            background: var(--white);
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .btn-secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .filter-btn {
            background: var(--light-gray);
            color: var(--dark-gray);
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .filter-btn.active {
            background: var(--primary-red);
            color: var(--white);
        }

        [data-theme="dark"] .sections-order-list,
        [data-theme="dark"] .section-order-item {
            background: var(--light-gray);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Theme Toggle (wie Hauptseite) */
        .theme-toggle {
            position: relative;
            width: 70px;
            height: 35px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 20px;
            cursor: pointer;
            border: none;
            padding: 0;
            overflow: visible;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        [data-theme="dark"] .theme-toggle {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            box-shadow: 0 4px 15px rgba(100, 149, 237, 0.3);
        }

        .theme-toggle::before { content: none; }
        [data-theme="dark"] .theme-toggle::before { content: none; }

        .theme-toggle .sun {
            position: absolute;
            top: 50%;
            left: 5px;
            width: 25px;
            height: 25px;
            transform: translateY(-50%);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            z-index: 10;
            pointer-events: none;
        }

        .theme-toggle .sun::before {
            content: '‚òÄÔ∏è';
            font-size: 20px;
            display: block;
            line-height: 1;
        }

        [data-theme="dark"] .theme-toggle .sun {
            left: -35px;
            opacity: 0;
            transform: translateY(-50%) rotate(180deg) scale(0.8);
        }

        .theme-toggle .moon {
            position: absolute;
            top: 50%;
            right: -35px;
            width: 25px;
            height: 25px;
            transform: translateY(-50%) rotate(-180deg) scale(0.8);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            z-index: 10;
            pointer-events: none;
        }

        .theme-toggle .moon::before {
            content: 'üåô';
            font-size: 20px;
            display: block;
            line-height: 1;
        }

        [data-theme="dark"] .theme-toggle .moon {
            right: 5px;
            opacity: 1;
            transform: translateY(-50%) rotate(0deg) scale(1);
        }

        .theme-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-header {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-red);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .admin-current-user {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-gray);
            background: rgba(0,0,0,0.06);
            padding: 6px 14px;
            border-radius: 999px;
            margin-left: 4px;
        }

        .logout-btn {
            padding: 12px 25px;
            background: var(--primary-red);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .logout-btn:hover {
            background: var(--dark-red);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 20, 60, 0.3);
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Tabs */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e8e8e8;
            background: var(--white);
            padding: 0;
            border-radius: 15px 15px 0 0;
            overflow-x: auto;
        }

        .admin-tab {
            padding: 18px 30px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-gray);
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }

        .admin-tab:hover {
            color: var(--primary-red);
            background: rgba(220, 20, 60, 0.05);
        }

        .admin-tab.active {
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
            background: rgba(220, 20, 60, 0.05);
        }

        .admin-tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .admin-tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-section {
            background: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .upload-section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--dark-gray);
        }

        .upload-area {
            border: 3px dashed #e0e0e0;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--light-gray);
        }

        .upload-area:hover {
            border-color: var(--primary-red);
            background: rgba(220, 20, 60, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary-red);
            background: rgba(220, 20, 60, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: var(--text-gray);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .upload-input {
            display: none;
        }

        .upload-btn {
            margin-top: 20px;
            padding: 12px 30px;
            background: var(--primary-red);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: var(--dark-red);
            transform: translateY(-2px);
        }

        .gallery-preview {
            background: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .gallery-preview h2 {
            font-size: 24px;
            margin-bottom: 25px;
            color: var(--dark-gray);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .gallery-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 4/3;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(220, 20, 60, 0.9);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            opacity: 0;
        }

        .gallery-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: var(--dark-red);
            transform: scale(1.1);
        }

        .gallery-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .gallery-item.drag-over {
            border: 3px dashed var(--primary-red);
            transform: scale(1.05);
        }

        .move-buttons {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .gallery-item:hover .move-buttons {
            opacity: 1;
        }

        .move-btn {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .move-btn:hover {
            background: var(--primary-red);
            color: var(--white);
            transform: scale(1.1);
        }

        .empty-gallery {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-gray);
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* News Management */
        .news-section {
            background: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .news-form {
            background: var(--light-gray);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-gray);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary-red);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--dark-red);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--text-gray);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: var(--dark-gray);
        }

        .btn-danger {
            background: #dc3545;
            color: var(--white);
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #ffc107;
            color: var(--dark-gray);
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .news-list {
            margin-top: 30px;
        }

        .news-item {
            background: var(--light-gray);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .news-item-content {
            flex: 1;
        }

        .news-item-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .news-item-date {
            font-size: 14px;
            color: var(--text-gray);
        }

        .news-item-actions {
            display: flex;
            gap: 10px;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        /* Text Editor */
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            background: var(--light-gray);
            border: 2px solid #e8e8e8;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
        }

        .editor-btn {
            padding: 8px 12px;
            background: var(--white);
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 35px;
            height: 35px;
        }

        .editor-btn:hover {
            background: var(--primary-red);
            color: var(--white);
            border-color: var(--primary-red);
        }

        .editor-btn.active {
            background: var(--primary-red);
            color: var(--white);
            border-color: var(--primary-red);
        }

        .editor-content {
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e8e8e8;
            border-top: none;
            border-radius: 0 0 8px 8px;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.6;
            background: var(--white);
            outline: none;
            overflow-y: auto;
        }

        .editor-content:focus {
            border-color: var(--primary-red);
        }

        .editor-content p {
            margin: 0 0 10px 0;
        }

        .color-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .color-picker {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            z-index: 100;
            background: var(--white);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
        }

        .color-picker.show {
            display: block;
        }

        .font-size-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Contact Messages */
        .messages-section {
            background: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .messages-count {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .count-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .count-badge.new {
            background: #dc3545;
            color: var(--white);
        }

        .count-badge.completed {
            background: #28a745;
            color: var(--white);
        }

        .message-item {
            background: var(--light-gray);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-red);
            transition: all 0.3s;
        }

        .message-item.completed {
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .message-item.new {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .message-info {
            flex: 1;
        }

        .message-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .message-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 10px;
        }

        .message-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message-date {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 5px;
        }

        .message-content {
            background: var(--white);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: var(--text-gray);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.new {
            background: #dc3545;
            color: var(--white);
        }

        .status-badge.completed {
            background: #28a745;
            color: var(--white);
        }

        .messages-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-gray);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e8e8e8;
            background: var(--white);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .filter-btn.active {
            background: var(--primary-red);
            color: var(--white);
            border-color: var(--primary-red);
        }

        .filter-btn:hover:not(.active) {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Sections Order Styles */
        .sections-order-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section-order-item {
            background: var(--white);
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: move;
            transition: all 0.3s;
            position: relative;
        }

        .section-order-item:hover {
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(220, 20, 60, 0.1);
            transform: translateY(-2px);
        }

        .section-order-item.dragging {
            opacity: 0.5;
            border-color: var(--primary-red);
            box-shadow: 0 8px 25px rgba(220, 20, 60, 0.3);
        }

        .section-order-item.drag-over {
            border-color: var(--primary-red);
            background: rgba(220, 20, 60, 0.05);
            transform: scale(1.02);
        }

        .section-order-handle {
            font-size: 24px;
            color: var(--text-gray);
            cursor: grab;
            user-select: none;
        }

        .section-order-handle:active {
            cursor: grabbing;
        }

        .section-order-info {
            flex: 1;
        }

        .section-order-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .section-order-id {
            font-size: 14px;
            color: var(--text-gray);
        }

        .section-order-actions {
            display: flex;
            gap: 10px;
        }

        .move-section-btn {
            padding: 8px 12px;
            background: var(--light-gray);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            color: var(--dark-gray);
        }

        .move-section-btn:hover {
            background: var(--primary-red);
            color: var(--white);
        }

        .move-section-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Users management */
        .users-section {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .users-section h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--dark-gray);
        }

        .users-hint {
            color: var(--text-gray);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .users-form {
            position: relative;
            background: radial-gradient(circle at top left, rgba(220, 20, 60, 0.05), transparent 60%), var(--white);
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 14px 35px rgba(15, 23, 42, 0.16);
            overflow: hidden;
        }

        .users-form::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(120deg, rgba(220, 20, 60, 0.18), transparent 40%, transparent 60%, rgba(220, 20, 60, 0.15));
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .users-form:hover::before {
            opacity: 1;
            transform: translateY(0);
        }

        .users-form .form-group input {
            transition: all 0.25s ease;
        }

        .users-form .form-group input:focus {
            box-shadow: 0 0 0 1px rgba(220, 20, 60, 0.15), 0 0 0 4px rgba(220, 20, 60, 0.08);
            border-color: rgba(220, 20, 60, 0.6);
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px 20px;
            margin: 20px 0 10px;
        }

        .perm-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--dark-gray);
            padding: 8px 10px;
            border-radius: 999px;
            background: rgba(248, 248, 248, 0.8);
            transition: all 0.2s ease;
        }

        .perm-item input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-red);
        }

        .perm-item:hover {
            background: rgba(220, 20, 60, 0.06);
            transform: translateY(-1px);
        }

        .users-list {
            background: var(--white);
            padding: 24px 30px;
            border-radius: 18px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
        }

        .users-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .users-list-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .users-count-pill {
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-gray);
            font-size: 12px;
        }

        .user-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            gap: 12px;
        }

        .user-row:last-child {
            border-bottom: none;
        }

        .user-row.animate-user-row {
            animation: usersRowIn 0.35s ease-out;
        }

        @keyframes usersRowIn {
            from {
                opacity: 0;
                transform: translateY(6px) scale(0.99);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .user-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-name {
            font-weight: 600;
            color: var(--dark-gray);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .user-name::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.7); /* offline –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }

        .user-name.user-online::before {
            background: rgba(34, 197, 94, 0.9);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
        }

        .user-name.user-offline::before {
            background: rgba(148, 163, 184, 0.7);
            box-shadow: none;
        }

        .user-meta {
            font-size: 12px;
            color: var(--text-gray);
        }

        .user-status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .user-status-badge.logged-in {
            background: rgba(34, 197, 94, 0.15);
            color: #15803d;
        }

        .user-status-badge.logged-out {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-gray);
        }

        .user-perms {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 12px;
        }

        .user-perm-badge {
            padding: 4px 9px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.12);
            color: var(--dark-gray);
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-actions .btn {
            padding: 6px 10px;
            font-size: 12px;
        }

        .user-superadmin {
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(220, 20, 60, 0.08);
            color: var(--primary-red);
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* Statistik */
        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 28px;
        }
        .stats-section h2 {
            font-size: 22px;
            margin-bottom: 4px;
            color: var(--dark-gray);
        }
        .stats-section p {
            color: var(--text-gray);
            font-size: 14px;
            margin-bottom: 16px;
        }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 8px;
        }
        .stat-card {
            background: var(--white);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(0,0,0,0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
        }
        .stat-card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-red);
            line-height: 1.2;
        }
        .stat-card-label {
            font-size: 13px;
            color: var(--text-gray);
            margin-top: 4px;
        }
        .stats-chart-wrap {
            background: var(--white);
            border-radius: 14px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(0,0,0,0.06);
            margin-bottom: 8px;
        }
        .stats-chart-wrap h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--dark-gray);
        }
        .stats-chart-wrap canvas {
            max-height: 280px;
        }
        .stats-chart-wrap {
            animation: statsCardIn 0.5s ease-out backwards;
        }
        .stats-chart-wrap:nth-child(3) { animation-delay: 0.05s; }
        .stats-chart-wrap:nth-child(4) { animation-delay: 0.12s; }
        .stats-chart-wrap:nth-child(5) { animation-delay: 0.19s; }
        .stats-chart-wrap:nth-child(6) { animation-delay: 0.26s; }
        .stats-chart-wrap:nth-child(7) { animation-delay: 0.33s; }
        @keyframes statsCardIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .stat-card {
            animation: statCardPop 0.4s ease-out backwards;
        }
        .stat-card:nth-child(1) { animation-delay: 0.02s; }
        .stat-card:nth-child(2) { animation-delay: 0.06s; }
        .stat-card:nth-child(3) { animation-delay: 0.1s; }
        .stat-card:nth-child(4) { animation-delay: 0.14s; }
        .stat-card:nth-child(5) { animation-delay: 0.18s; }
        @keyframes statCardPop {
            from {
                opacity: 0;
                transform: scale(0.92) translateY(8px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>VVO Admin Panel <span id="currentUserDisplay" class="admin-current-user"></span></h1>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="theme-toggle-container">
                    <button class="theme-toggle" id="themeToggle" aria-label="Theme wechseln">
                        <span class="sun"></span>
                        <span class="moon"></span>
                    </button>
                </div>
                <a href="index.html" class="logout-btn">Abmelden</a>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="gallery">üì∑ Galerie</button>
            <button class="admin-tab" data-tab="news">üì∞ Neuigkeiten</button>
            <button class="admin-tab" data-tab="messages">‚úâÔ∏è Nachrichten</button>
            <button class="admin-tab" data-tab="order">üìã Reihenfolge</button>
            <button class="admin-tab" data-tab="users">üë§ Benutzer</button>
            <button class="admin-tab" data-tab="stats">üìä Statistik</button>
        </div>

        <!-- Gallery Tab -->
        <div class="admin-tab-content active" id="galleryTab">
            <div class="upload-section">
                <h2>Bilder hochladen</h2>
                <div class="success-message" id="successMessage">
                    Bild erfolgreich hochgeladen!
                </div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Ziehen Sie Bilder hierher oder klicken Sie zum Ausw√§hlen</div>
                    <input type="file" id="fileInput" class="upload-input" accept="image/*" multiple>
                    <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Dateien ausw√§hlen
                    </button>
                </div>
            </div>

            <div class="gallery-preview">
                <h2>Galerie verwalten (<span id="imageCount">0</span> Bilder)</h2>
                <p style="color: var(--text-gray); margin-bottom: 20px; font-size: 14px;">
                    üí° Tipp: Ziehen Sie Bilder, um die Reihenfolge zu √§ndern, oder verwenden Sie die Pfeiltasten
                </p>
                <div class="gallery-grid" id="galleryGrid">
                    <div class="empty-gallery">
                        <p>Noch keine Bilder vorhanden</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Tab -->
        <div class="admin-tab-content" id="newsTab">
            <div class="news-section">
                <h2>Neuigkeiten verwalten</h2>
                
                <div class="news-form" id="newsForm">
                <input type="hidden" id="editingNewsId" value="">
                <div class="form-row">
                    <div class="form-group">
                        <label for="newsTitle">Titel</label>
                        <input type="text" id="newsTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="newsDate">Datum</label>
                        <input type="date" id="newsDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newsText">Text</label>
                    <div class="editor-toolbar" id="editorToolbar">
                        <button type="button" class="editor-btn" data-command="bold" title="Fett">B</button>
                        <button type="button" class="editor-btn" data-command="italic" title="Kursiv">I</button>
                        <button type="button" class="editor-btn" data-command="underline" title="Unterstrichen">U</button>
                        <button type="button" class="editor-btn" data-command="strikeThrough" title="Durchgestrichen">S</button>
                        <div style="width: 1px; height: 25px; background: #ddd; margin: 0 5px;"></div>
                        <button type="button" class="editor-btn" data-command="justifyLeft" title="Links">‚óÄ</button>
                        <button type="button" class="editor-btn" data-command="justifyCenter" title="Zentriert">‚óè</button>
                        <button type="button" class="editor-btn" data-command="justifyRight" title="Rechts">‚ñ∂</button>
                        <div style="width: 1px; height: 25px; background: #ddd; margin: 0 5px;"></div>
                        <select class="font-size-select" id="fontSizeSelect" title="Schriftgr√∂√üe">
                            <option value="12">12px</option>
                            <option value="14">14px</option>
                            <option value="16" selected>16px</option>
                            <option value="18">18px</option>
                            <option value="20">20px</option>
                            <option value="24">24px</option>
                            <option value="28">28px</option>
                            <option value="32">32px</option>
                        </select>
                        <div class="color-input-wrapper">
                            <button type="button" class="editor-btn" id="textColorBtn" title="Textfarbe">A</button>
                            <div class="color-picker" id="textColorPicker">
                                <input type="color" id="textColorInput" value="#000000">
                            </div>
                        </div>
                        <div class="color-input-wrapper">
                            <button type="button" class="editor-btn" id="bgColorBtn" title="Hintergrundfarbe">‚ñÆ</button>
                            <div class="color-picker" id="bgColorPicker">
                                <input type="color" id="bgColorInput" value="#ffffff">
                            </div>
                        </div>
                        <div style="width: 1px; height: 25px; background: #ddd; margin: 0 5px;"></div>
                        <button type="button" class="editor-btn" data-command="insertUnorderedList" title="Aufz√§hlung">‚Ä¢</button>
                        <button type="button" class="editor-btn" data-command="insertOrderedList" title="Nummerierte Liste">1.</button>
                        <div style="width: 1px; height: 25px; background: #ddd; margin: 0 5px;"></div>
                        <button type="button" class="editor-btn" data-command="formatBlock" data-value="h2" title="√úberschrift">H2</button>
                        <button type="button" class="editor-btn" data-command="formatBlock" data-value="h3" title="Unter√ºberschrift">H3</button>
                        <button type="button" class="editor-btn" data-command="formatBlock" data-value="p" title="Absatz">P</button>
                    </div>
                    <div class="editor-content" id="newsText" contenteditable="true" required></div>
                </div>
                <div class="form-group">
                    <label for="newsImage">Bild (optional)</label>
                    <input type="file" id="newsImage" accept="image/*">
                    <img id="newsImagePreview" class="image-preview" alt="Preview">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" id="saveNewsBtn">Speichern</button>
                    <button type="button" class="btn btn-secondary" id="cancelNewsBtn" style="display: none;">Abbrechen</button>
                </div>
            </div>
            <div class="news-list" id="newsList">
                <p style="text-align: center; color: var(--text-gray);">Lade Neuigkeiten...</p>
            </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div class="admin-tab-content" id="messagesTab">
            <div class="messages-section">
            <div class="messages-header">
                <h2>Kontaktnachrichten</h2>
                <div class="messages-count">
                    <span class="count-badge new" id="newCount">0 Neu</span>
                    <span class="count-badge completed" id="completedCount">0 Erledigt</span>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Alle</button>
                <button class="filter-btn" data-filter="new">Neu</button>
                <button class="filter-btn" data-filter="completed">Erledigt</button>
            </div>
            <div id="messagesList">
                <div class="messages-empty">
                    <p>Noch keine Nachrichten vorhanden</p>
                </div>
            </div>
            </div>
        </div>

        <!-- Order Tab -->
        <div class="admin-tab-content" id="orderTab">
            <div class="upload-section">
                <h2>Reihenfolge der Seitenabschnitte</h2>
                <p style="color: var(--text-gray); margin-bottom: 30px; font-size: 14px;">
                    üí° Ziehen Sie die Abschnitte, um ihre Reihenfolge auf der Hauptseite zu √§ndern. Die Navigation wird automatisch aktualisiert.
                </p>
                <div id="sectionsOrderList" class="sections-order-list">
                    <!-- Sections will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="admin-tab-content" id="usersTab">
            <div class="users-section">
                <div>
                    <h2>Benutzerverwaltung</h2>
                    <p class="users-hint">
                        Legen Sie zus√§tzliche Benutzer f√ºr das Admin-Panel an und vergeben Sie detaillierte Rechte.
                    </p>
                </div>

                <div class="users-form">
                    <input type="hidden" id="editingUserId" value="">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userLogin">Benutzername</label>
                            <input type="text" id="userLogin" required>
                        </div>
                        <div class="form-group">
                            <label for="userPassword">Passwort</label>
                            <input type="password" id="userPassword" placeholder="Mindestens 6 Zeichen">
                        </div>
                        <div class="form-group">
                            <label for="userPasswordConfirm">Passwort wiederholen</label>
                            <input type="password" id="userPasswordConfirm">
                        </div>
                    </div>

                    <h3 style="font-size: 16px; margin-top: 20px;">Rechte</h3>
                    <div class="permissions-grid">
                        <label class="perm-item">
                            <input type="checkbox" id="permGallery">
                            <span>Galerie verwalten</span>
                        </label>
                        <label class="perm-item">
                            <input type="checkbox" id="permNews">
                            <span>Neuigkeiten verwalten</span>
                        </label>
                        <label class="perm-item">
                            <input type="checkbox" id="permMessages">
                            <span>Kontaktnachrichten verwalten</span>
                        </label>
                        <label class="perm-item">
                            <input type="checkbox" id="permOrder">
                            <span>Reihenfolge der Abschnitte √§ndern</span>
                        </label>
                        <label class="perm-item">
                            <input type="checkbox" id="permUsers">
                            <span>Benutzer verwalten (diese Seite)</span>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" id="saveUserBtn">Benutzer speichern</button>
                        <button type="button" class="btn btn-secondary" id="cancelUserEditBtn" style="display: none;">Abbrechen</button>
                    </div>

                    <div class="error-message" id="userErrorMessage"></div>
                </div>

                <div class="users-list" id="usersList">
                    <div class="users-list-header">
                        <div class="users-list-title">
                            üë§ Benutzer√ºbersicht
                            <span class="users-count-pill" id="usersCountPill">0 Benutzer</span>
                        </div>
                    </div>
                    <div id="usersListBody">
                        <p style="text-align: center; color: var(--text-gray);">Noch keine Benutzer angelegt</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div class="admin-tab-content" id="statsTab">
            <div class="stats-section">
                <div>
                    <h2>üìä √úbersicht</h2>
                    <p>Zahlen und Grafiken zu Besuchen, R√ºckmeldungen und Aktivit√§t.</p>
                </div>
                <div class="stats-cards" id="statsCards">
                    <div class="stat-card"><div class="stat-card-value" id="statVisitsTotal">0</div><div class="stat-card-label">Besuche (gesamt)</div></div>
                    <div class="stat-card"><div class="stat-card-value" id="statMessagesTotal">0</div><div class="stat-card-label">Kontaktnachrichten</div></div>
                    <div class="stat-card"><div class="stat-card-value" id="statNewsTotal">0</div><div class="stat-card-label">Neuigkeiten</div></div>
                    <div class="stat-card"><div class="stat-card-value" id="statGalleryTotal">0</div><div class="stat-card-label">Galerie-Bilder</div></div>
                    <div class="stat-card"><div class="stat-card-value" id="statUsersTotal">0</div><div class="stat-card-label">Benutzer</div></div>
                </div>

                <div class="stats-chart-wrap">
                    <h3>Besuche der Website (letzte 14 Tage)</h3>
                    <canvas id="chartVisits" width="400" height="200"></canvas>
                </div>
                <div class="stats-chart-wrap">
                    <h3>Kontaktnachrichten ‚Äî Neu vs. Erledigt</h3>
                    <canvas id="chartMessages" width="400" height="200"></canvas>
                </div>
                <div class="stats-chart-wrap">
                    <h3>R√ºckmeldungen pro Tag (letzte 14 Tage)</h3>
                    <canvas id="chartMessagesByDay" width="400" height="200"></canvas>
                </div>
                <div class="stats-chart-wrap">
                    <h3>Aktivit√§t der Benutzer</h3>
                    <canvas id="chartUsers" width="400" height="200"></canvas>
                </div>
                <div class="stats-chart-wrap">
                    <h3>Neuigkeiten pro Monat</h3>
                    <canvas id="chartNews" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme sofort setzen (wie Hauptseite ‚Äî gleicher Key "theme")
        (function () {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
        })();

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏–∑ localStorage (–µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–ª–∏ –≤–∫–ª–∞–¥–∫—É, –∞ –Ω–µ –≤—ã—à–ª–∏)
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            try {
                const stored = localStorage.getItem('adminStoredSession');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data && data.username) {
                        sessionStorage.setItem('adminLoggedIn', 'true');
                        sessionStorage.setItem('currentUser', JSON.stringify({
                            username: data.username,
                            isSuperAdmin: !!data.isSuperAdmin,
                            permissions: data.permissions || {}
                        }));
                    }
                }
            } catch (e) {
                console.error('Fehler beim Wiederherstellen der Sitzung:', e);
            }
        }

        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'admin.html';
        }

        // Aktueller –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –µ–≥–æ –ø—Ä–∞–≤–∞ (–∏–∑ sessionStorage)
        let currentUser = null;
        let currentPermissions = {
            gallery: true,
            news: true,
            messages: true,
            order: true,
            users: true,
            stats: true
        };

        try {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                if (currentUser.permissions) {
                    currentPermissions = { ...currentPermissions, ...currentUser.permissions };
                }
            }
        } catch (e) {
            console.error('Fehler beim Lesen des aktuellen Benutzers:', e);
        }

        const currentUserDisplayEl = document.getElementById('currentUserDisplay');
        if (currentUserDisplayEl && currentUser && currentUser.username) {
            currentUserDisplayEl.textContent = currentUser.username;
        }

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const htmlEl = document.documentElement;
        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            htmlEl.setAttribute('data-theme', saved);
        }
        function toggleTheme() {
            const current = htmlEl.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            htmlEl.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }
        if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
        window.addEventListener('storage', function (e) {
            if (e.key === 'theme') htmlEl.setAttribute('data-theme', e.newValue || 'light');
        });

        function hasPermission(key) {
            return !!currentPermissions[key];
        }

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const galleryGrid = document.getElementById('galleryGrid');
        const imageCount = document.getElementById('imageCount');
        const successMessage = document.getElementById('successMessage');

        // Move image up
        window.moveImageUp = function(index) {
            if (index === 0) return;
            const images = JSON.parse(localStorage.getItem('galleryImages') || '[]');
            [images[index - 1], images[index]] = [images[index], images[index - 1]];
            localStorage.setItem('galleryImages', JSON.stringify(images));
            loadGallery();
            window.dispatchEvent(new Event('galleryUpdated'));
        };

        // Move image down
        window.moveImageDown = function(index) {
            const images = JSON.parse(localStorage.getItem('galleryImages') || '[]');
            if (index === images.length - 1) return;
            [images[index], images[index + 1]] = [images[index + 1], images[index]];
            localStorage.setItem('galleryImages', JSON.stringify(images));
            loadGallery();
            window.dispatchEvent(new Event('galleryUpdated'));
        };

        // Load existing images
        function loadGallery() {
            const images = JSON.parse(localStorage.getItem('galleryImages') || '[]');
            imageCount.textContent = images.length;

            if (images.length === 0) {
                galleryGrid.innerHTML = '<div class="empty-gallery"><p>Noch keine Bilder vorhanden</p></div>';
                return;
            }

            galleryGrid.innerHTML = '';
            images.forEach((imageData, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.draggable = true;
                item.dataset.index = index;
                
                const moveButtons = index > 0 || index < images.length - 1 
                    ? `<div class="move-buttons">
                        ${index > 0 ? `<button class="move-btn" onclick="moveImageUp(${index})" title="Nach oben">‚Üë</button>` : ''}
                        ${index < images.length - 1 ? `<button class="move-btn" onclick="moveImageDown(${index})" title="Nach unten">‚Üì</button>` : ''}
                       </div>`
                    : '';
                
                item.innerHTML = `
                    ${moveButtons}
                    <img src="${imageData}" alt="Gallery ${index + 1}">
                    <button class="delete-btn" onclick="deleteImage(${index})">√ó</button>
                `;
                
                // Drag and drop for reordering
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', index);
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    document.querySelectorAll('.gallery-item').forEach(i => i.classList.remove('drag-over'));
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    item.classList.add('drag-over');
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    
                    const fromIndex = parseInt(e.dataTransfer.getData('text/html'));
                    const toIndex = index;
                    
                    if (fromIndex !== toIndex) {
                        const images = JSON.parse(localStorage.getItem('galleryImages') || '[]');
                        const [movedItem] = images.splice(fromIndex, 1);
                        images.splice(toIndex, 0, movedItem);
                        localStorage.setItem('galleryImages', JSON.stringify(images));
                        loadGallery();
                        window.dispatchEvent(new Event('galleryUpdated'));
                    }
                });

                galleryGrid.appendChild(item);
            });
        }

        // Delete image
        function deleteImage(index) {
            if (confirm('M√∂chten Sie dieses Bild wirklich l√∂schen?')) {
                const images = JSON.parse(localStorage.getItem('galleryImages') || '[]');
                images.splice(index, 1);
                localStorage.setItem('galleryImages', JSON.stringify(images));
                loadGallery();
                // Trigger custom event for same-tab updates
                window.dispatchEvent(new Event('galleryUpdated'));
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Handle file upload
        async function handleFiles(files) {
            const images = JSON.parse(localStorage.getItem('galleryImages') || '[]');
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    try {
                        const base64 = await fileToBase64(file);
                        images.push(base64);
                    } catch (error) {
                        console.error('Error converting file:', error);
                    }
                }
            }

            localStorage.setItem('galleryImages', JSON.stringify(images));
            loadGallery();
            // Trigger custom event for same-tab updates
            window.dispatchEvent(new Event('galleryUpdated'));
            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 3000);
        }

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            e.target.value = '';
        });

        // Click to upload
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —ç—Ç—É –≤–∫–ª–∞–¥–∫—É –∫–∞–∫ "–æ–Ω–ª–∞–π–Ω" –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–Ω–µ–ª–∏
        registerThisTab();

        // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/—É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî —Å–Ω–∏–º–∞–µ–º —ç—Ç—É –≤–∫–ª–∞–¥–∫—É —Å —Å–µ—Å—Å–∏–∏ (—Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è —É –¥—Ä—É–≥–∏—Ö)
        window.addEventListener('beforeunload', () => {
            unregisterThisTab();
        });

        // Logout ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ —Å–µ—Å—Å–∏—é, –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≤—Ö–æ–¥ (–ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω—É–∂–µ–Ω –ª–æ–≥–∏–Ω)
        document.querySelector('.logout-btn').addEventListener('click', () => {
            unregisterThisTab();
            sessionStorage.removeItem('adminTabId');
            sessionStorage.removeItem('adminLoggedIn');
            sessionStorage.removeItem('currentUser');
            localStorage.removeItem('adminStoredSession');
        });

        // Tab switching functionality + Rechte
        const tabs = document.querySelectorAll('.admin-tab');
        const tabContents = document.querySelectorAll('.admin-tab-content');

        // Initiale Sichtbarkeit der Tabs nach Rechten
        tabs.forEach(tab => {
            const tabKey = tab.getAttribute('data-tab');
            const content = document.getElementById(tabKey + 'Tab');

            if (!hasPermission(tabKey)) {
                // Tabs ohne Rechte ausblenden
                tab.style.display = 'none';
                if (content) {
                    content.classList.remove('active');
                }
            }
        });

        // Sicherstellen, dass ein Tab aktiv ist
        (function ensureActiveTab() {
            let activeFound = false;
            tabs.forEach(tab => {
                const tabKey = tab.getAttribute('data-tab');
                const content = document.getElementById(tabKey + 'Tab');
                if (!hasPermission(tabKey)) return;
                
                if (!activeFound) {
                    tab.classList.add('active');
                    if (content) content.classList.add('active');
                    activeFound = true;
                } else {
                    tab.classList.remove('active');
                    if (content) content.classList.remove('active');
                }
            });
        })();

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.getAttribute('data-tab');

                if (!hasPermission(targetTab)) {
                    return;
                }
                
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(targetTab + 'Tab').classList.add('active');

                // Bei √ñffnen des Order-Tabs Reihenfolge laden
                if (targetTab === 'order') {
                    setTimeout(loadSectionsOrder, 100);
                }

                // Bei √ñffnen des Users-Tabs Benutzerliste aktualisieren
                if (targetTab === 'users') {
                    loadUsers();
                }
                if (targetTab === 'stats') {
                    setTimeout(loadStats, 100);
                }
            });
        });

        // Load gallery on page load
        loadGallery();

        // News Management
        let editingNewsId = null;
        let newsImageBase64 = null;

        // Load news list
        function loadNewsList() {
            const newsList = document.getElementById('newsList');
            const news = JSON.parse(localStorage.getItem('news') || '[]');

            if (news.length === 0) {
                newsList.innerHTML = '<p style="text-align: center; color: var(--text-gray);">Noch keine Neuigkeiten vorhanden</p>';
                return;
            }

            // Create array with original indices
            const newsWithIndices = news.map((item, index) => ({ ...item, originalIndex: index }));
            // Sort by date (newest first)
            const sortedNews = newsWithIndices.sort((a, b) => new Date(b.date) - new Date(a.date));

            newsList.innerHTML = '';
            sortedNews.forEach((item) => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                const date = new Date(item.date).toLocaleDateString('de-DE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                newsItem.innerHTML = `
                    <div class="news-item-content">
                        <div class="news-item-title">${item.title}</div>
                        <div class="news-item-date">${date}</div>
                    </div>
                    <div class="news-item-actions">
                        <button class="btn btn-edit" onclick="editNews(${item.originalIndex})">Bearbeiten</button>
                        <button class="btn btn-danger" onclick="deleteNews(${item.originalIndex})">L√∂schen</button>
                    </div>
                `;
                newsList.appendChild(newsItem);
            });
        }

        // Text Editor functionality
        const editor = document.getElementById('newsText');
        const toolbar = document.getElementById('editorToolbar');

        // Toolbar button handlers
        toolbar.querySelectorAll('[data-command]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const command = btn.getAttribute('data-command');
                const value = btn.getAttribute('data-value');
                
                editor.focus();
                if (value) {
                    document.execCommand(command, false, value);
                } else {
                    document.execCommand(command, false, null);
                }
                updateToolbarState();
            });
        });

        // Font size handler
        document.getElementById('fontSizeSelect').addEventListener('change', (e) => {
            editor.focus();
            document.execCommand('fontSize', false, '3');
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.fontSize = e.target.value + 'px';
                try {
                    range.surroundContents(span);
                } catch (err) {
                    span.appendChild(range.extractContents());
                    range.insertNode(span);
                }
            }
        });

        // Text color handler
        document.getElementById('textColorBtn').addEventListener('click', () => {
            const picker = document.getElementById('textColorPicker');
            picker.classList.toggle('show');
        });

        document.getElementById('textColorInput').addEventListener('change', (e) => {
            editor.focus();
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.color = e.target.value;
                try {
                    range.surroundContents(span);
                } catch (err) {
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                }
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                document.execCommand('foreColor', false, e.target.value);
            }
            document.getElementById('textColorPicker').classList.remove('show');
            updateToolbarState();
        });

        // Background color handler
        document.getElementById('bgColorBtn').addEventListener('click', () => {
            const picker = document.getElementById('bgColorPicker');
            picker.classList.toggle('show');
        });

        document.getElementById('bgColorInput').addEventListener('change', (e) => {
            editor.focus();
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.backgroundColor = e.target.value;
                try {
                    range.surroundContents(span);
                } catch (err) {
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                }
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                document.execCommand('backColor', false, e.target.value);
            }
            document.getElementById('bgColorPicker').classList.remove('show');
            updateToolbarState();
        });

        // Update toolbar button states
        function updateToolbarState() {
            toolbar.querySelectorAll('[data-command]').forEach(btn => {
                const command = btn.getAttribute('data-command');
                const value = btn.getAttribute('data-value');
                
                try {
                    if (value) {
                        btn.classList.toggle('active', document.queryCommandValue(command) === value);
                    } else {
                        btn.classList.toggle('active', document.queryCommandState(command));
                    }
                } catch (e) {}
            });
        }

        editor.addEventListener('input', updateToolbarState);
        editor.addEventListener('selectionchange', updateToolbarState);

        // Close color pickers when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.color-input-wrapper')) {
                document.getElementById('textColorPicker').classList.remove('show');
                document.getElementById('bgColorPicker').classList.remove('show');
            }
        });

        // Normalize HTML to ensure inline styles are preserved
        function normalizeHTML(html) {
            // Create a temporary div to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            // Convert font tags to span with style
            temp.querySelectorAll('font').forEach(font => {
                const span = document.createElement('span');
                if (font.color) span.style.color = font.color;
                if (font.face) span.style.fontFamily = font.face;
                if (font.size) {
                    const size = parseInt(font.size);
                    if (size) span.style.fontSize = (size * 2 + 10) + 'px';
                }
                span.innerHTML = font.innerHTML;
                font.parentNode.replaceChild(span, font);
            });
            
            // Convert elements with color attribute to style
            temp.querySelectorAll('[color]').forEach(el => {
                if (!el.style.color) {
                    el.style.color = el.getAttribute('color');
                }
                el.removeAttribute('color');
            });
            
            // Convert bgcolor attribute to background-color style
            temp.querySelectorAll('[bgcolor]').forEach(el => {
                if (!el.style.backgroundColor) {
                    el.style.backgroundColor = el.getAttribute('bgcolor');
                }
                el.removeAttribute('bgcolor');
            });
            
            // Ensure all style attributes are preserved and properly formatted
            temp.querySelectorAll('*').forEach(el => {
                if (el.style && el.style.length > 0) {
                    // Force style attribute to be preserved
                    const computedStyle = el.style.cssText;
                    if (computedStyle) {
                        el.setAttribute('style', computedStyle);
                    }
                }
            });
            
            return temp.innerHTML;
        }

        // Save news
        document.getElementById('saveNewsBtn').addEventListener('click', async () => {
            const title = document.getElementById('newsTitle').value;
            const date = document.getElementById('newsDate').value;
            let html = editor.innerHTML;
            const text = editor.innerText || editor.textContent;
            const editingId = document.getElementById('editingNewsId').value;

            if (!title || !date || !text.trim()) {
                alert('Bitte f√ºllen Sie alle Pflichtfelder aus!');
                return;
            }

            // Normalize HTML to preserve all formatting
            html = normalizeHTML(html);

            const news = JSON.parse(localStorage.getItem('news') || '[]');
            const newsItem = {
                title,
                date,
                text: text.trim(),
                html: html,
                image: newsImageBase64 || null
            };

            if (editingId !== '') {
                // Update existing news
                news[parseInt(editingId)] = newsItem;
            } else {
                // Add new news
                news.push(newsItem);
            }

            localStorage.setItem('news', JSON.stringify(news));
            loadNewsList();
            resetNewsForm();
            window.dispatchEvent(new Event('newsUpdated'));
            alert('Neuigkeit erfolgreich gespeichert!');
        });

        // Edit news
        window.editNews = function(index) {
            const news = JSON.parse(localStorage.getItem('news') || '[]');
            const item = news[index];

            document.getElementById('newsTitle').value = item.title;
            document.getElementById('newsDate').value = item.date;
            // Load HTML content if available, otherwise plain text
            editor.innerHTML = item.html || item.text || '';
            document.getElementById('editingNewsId').value = index;
            document.getElementById('cancelNewsBtn').style.display = 'block';

            if (item.image) {
                document.getElementById('newsImagePreview').src = item.image;
                document.getElementById('newsImagePreview').classList.add('show');
                newsImageBase64 = item.image;
            } else {
                document.getElementById('newsImagePreview').classList.remove('show');
                newsImageBase64 = null;
            }

            // Scroll to form
            document.getElementById('newsForm').scrollIntoView({ behavior: 'smooth' });
        };

        // Delete news
        window.deleteNews = function(index) {
            if (confirm('M√∂chten Sie diese Neuigkeit wirklich l√∂schen?')) {
                const news = JSON.parse(localStorage.getItem('news') || '[]');
                news.splice(index, 1);
                localStorage.setItem('news', JSON.stringify(news));
                loadNewsList();
                window.dispatchEvent(new Event('newsUpdated'));
            }
        };

        // Cancel editing
        document.getElementById('cancelNewsBtn').addEventListener('click', () => {
            resetNewsForm();
        });

        // Reset news form (newsForm ist ein div ‚Äî Felder manuell leeren)
        function resetNewsForm() {
            document.getElementById('newsTitle').value = '';
            document.getElementById('newsDate').value = '';
            editor.innerHTML = '';
            document.getElementById('editingNewsId').value = '';
            const imgInput = document.getElementById('newsImage');
            if (imgInput) imgInput.value = '';
            document.getElementById('newsImagePreview').classList.remove('show');
            document.getElementById('newsImagePreview').removeAttribute('src');
            const cancelBtn = document.getElementById('cancelNewsBtn');
            if (cancelBtn) cancelBtn.style.display = 'none';
            newsImageBase64 = null;
            editingNewsId = null;
            updateToolbarState();
        }

        // Handle news image upload
        document.getElementById('newsImage').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                try {
                    newsImageBase64 = await fileToBase64(file);
                    document.getElementById('newsImagePreview').src = newsImageBase64;
                    document.getElementById('newsImagePreview').classList.add('show');
                } catch (error) {
                    console.error('Error converting image:', error);
                    alert('Fehler beim Laden des Bildes');
                }
            }
        });

        // Set default date to today
        document.getElementById('newsDate').valueAsDate = new Date();

        // Load news list on page load
        loadNewsList();

        // Contact Messages Management
        let currentFilter = 'all';

        // Load and display messages
        function loadMessages() {
            const messagesList = document.getElementById('messagesList');
            const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
            
            // Filter messages
            let filteredMessages = messages;
            if (currentFilter === 'new') {
                filteredMessages = messages.filter(m => m.status === 'new');
            } else if (currentFilter === 'completed') {
                filteredMessages = messages.filter(m => m.status === 'completed');
            }

            // Sort by date (newest first)
            filteredMessages.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Update counts
            const newCount = messages.filter(m => m.status === 'new').length;
            const completedCount = messages.filter(m => m.status === 'completed').length;
            document.getElementById('newCount').textContent = `${newCount} Neu`;
            document.getElementById('completedCount').textContent = `${completedCount} Erledigt`;

            if (filteredMessages.length === 0) {
                messagesList.innerHTML = '<div class="messages-empty"><p>Noch keine Nachrichten vorhanden</p></div>';
                return;
            }

            messagesList.innerHTML = '';
            filteredMessages.forEach((message) => {
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${message.status}`;
                
                const date = new Date(message.date).toLocaleDateString('de-DE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Escape HTML to prevent XSS
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };

                messageItem.innerHTML = `
                    <div class="message-header">
                        <div class="message-info">
                            <div class="message-name">${escapeHtml(message.name)}</div>
                            <div class="message-meta">
                                <div class="message-meta-item">
                                    <span>üìû</span>
                                    <span>${escapeHtml(message.phone)}</span>
                                </div>
                                <div class="message-meta-item">
                                    <span>‚úâÔ∏è</span>
                                    <a href="mailto:${escapeHtml(message.email)}" style="color: var(--primary-red); text-decoration: none;">${escapeHtml(message.email)}</a>
                                </div>
                            </div>
                            <div class="message-date">${date}</div>
                        </div>
                        <span class="status-badge ${message.status}">${message.status === 'new' ? 'Neu' : 'Erledigt'}</span>
                    </div>
                    <div class="message-content">${escapeHtml(message.message)}</div>
                    <div class="message-actions">
                        ${message.status === 'new' 
                            ? `<button class="btn btn-edit" onclick="markAsCompleted('${message.id}')">Als erledigt markieren</button>`
                            : `<button class="btn btn-secondary" onclick="markAsNew('${message.id}')">Als neu markieren</button>`
                        }
                        <button class="btn btn-danger" onclick="deleteMessage('${message.id}')">L√∂schen</button>
                    </div>
                `;
                messagesList.appendChild(messageItem);
            });
        }

        // Mark message as completed
        window.markAsCompleted = function(id) {
            const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
            const message = messages.find(m => m.id === id);
            if (message) {
                message.status = 'completed';
                localStorage.setItem('contactMessages', JSON.stringify(messages));
                loadMessages();
            }
        };

        // Mark message as new
        window.markAsNew = function(id) {
            const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
            const message = messages.find(m => m.id === id);
            if (message) {
                message.status = 'new';
                localStorage.setItem('contactMessages', JSON.stringify(messages));
                loadMessages();
            }
        };

        // Delete message
        window.deleteMessage = function(id) {
            if (confirm('M√∂chten Sie diese Nachricht wirklich l√∂schen?')) {
                const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
                const filtered = messages.filter(m => m.id !== id);
                localStorage.setItem('contactMessages', JSON.stringify(filtered));
                loadMessages();
            }
        };

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.getAttribute('data-filter');
                loadMessages();
            });
        });

        // Load messages on page load
        loadMessages();

        // Listen for new messages
        window.addEventListener('contactMessagesUpdated', () => {
            loadMessages();
        });

        window.addEventListener('storage', (e) => {
            if (e.key === 'contactMessages') {
                loadMessages();
            }
        });

        // Sections Order Management
        const sectionsConfig = [
            { id: 'about', title: '√úber uns', navTitle: '√úber uns' },
            { id: 'services', title: 'Leistungen', navTitle: 'Leistungen' },
            { id: 'features', title: 'Vorteile', navTitle: 'Vorteile' },
            { id: 'gallery', title: 'Galerie', navTitle: 'Galerie' },
            { id: 'news', title: 'Neuigkeiten', navTitle: 'Neuigkeiten' },
            { id: 'contact', title: 'Kontakt', navTitle: 'Kontakt' }
        ];

        function getSectionsOrder() {
            const saved = localStorage.getItem('sectionsOrder');
            if (saved) {
                try {
                    const order = JSON.parse(saved);
                    // Validate order - ensure all sections are present
                    const savedIds = order.map(s => s.id);
                    const allIds = sectionsConfig.map(s => s.id);
                    if (savedIds.length === allIds.length && allIds.every(id => savedIds.includes(id))) {
                        return order;
                    }
                } catch (e) {
                    console.error('Error parsing sections order:', e);
                }
            }
            // Default order
            return sectionsConfig;
        }

        function saveSectionsOrder(order) {
            localStorage.setItem('sectionsOrder', JSON.stringify(order));
            window.dispatchEvent(new Event('sectionsOrderUpdated'));
        }

        function loadSectionsOrder() {
            const order = getSectionsOrder();
            const list = document.getElementById('sectionsOrderList');
            
            if (!list) return;

            list.innerHTML = '';
            
            order.forEach((section, index) => {
                const item = document.createElement('div');
                item.className = 'section-order-item';
                item.draggable = true;
                item.dataset.sectionId = section.id;
                
                const config = sectionsConfig.find(s => s.id === section.id);
                const title = config ? config.title : section.title;
                
                item.innerHTML = `
                    <div class="section-order-handle">‚ò∞</div>
                    <div class="section-order-info">
                        <div class="section-order-title">${title}</div>
                        <div class="section-order-id">ID: ${section.id}</div>
                    </div>
                    <div class="section-order-actions">
                        <button class="move-section-btn" onclick="moveSectionUp(${index})" ${index === 0 ? 'disabled' : ''} title="Nach oben">‚Üë</button>
                        <button class="move-section-btn" onclick="moveSectionDown(${index})" ${index === order.length - 1 ? 'disabled' : ''} title="Nach unten">‚Üì</button>
                    </div>
                `;

                // Drag and drop
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', index);
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    document.querySelectorAll('.section-order-item').forEach(i => i.classList.remove('drag-over'));
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    item.classList.add('drag-over');
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    
                    const fromIndex = parseInt(e.dataTransfer.getData('text/html'));
                    const toIndex = index;
                    
                    if (fromIndex !== toIndex) {
                        const order = getSectionsOrder();
                        const [movedItem] = order.splice(fromIndex, 1);
                        order.splice(toIndex, 0, movedItem);
                        saveSectionsOrder(order);
                        loadSectionsOrder();
                    }
                });

                list.appendChild(item);
            });
        }

        window.moveSectionUp = function(index) {
            if (index === 0) return;
            const order = getSectionsOrder();
            [order[index - 1], order[index]] = [order[index], order[index - 1]];
            saveSectionsOrder(order);
            loadSectionsOrder();
        };

        window.moveSectionDown = function(index) {
            const order = getSectionsOrder();
            if (index === order.length - 1) return;
            [order[index], order[index + 1]] = [order[index + 1], order[index]];
            saveSectionsOrder(order);
            loadSectionsOrder();
        };

        // Load sections order when order tab is opened
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.getAttribute('data-tab') === 'order') {
                    setTimeout(loadSectionsOrder, 100);
                }
            });
        });

        // Load on page load if order tab is active
        if (document.getElementById('orderTab')?.classList.contains('active')) {
            loadSectionsOrder();
        }

        // --- Benutzerverwaltung ---

        function getStoredUsers() {
            try {
                return JSON.parse(localStorage.getItem('adminUsers') || '[]');
            } catch (e) {
                console.error('Fehler beim Lesen der Benutzerliste:', e);
                return [];
            }
        }

        function saveStoredUsers(users) {
            localStorage.setItem('adminUsers', JSON.stringify(users));
        }

        function getActiveSessions() {
            try {
                const raw = JSON.parse(localStorage.getItem('adminActiveSessions') || '{}');
                const out = {};
                for (const [user, val] of Object.entries(raw)) {
                    out[user] = Array.isArray(val) ? val : [];
                }
                return out;
            } catch (e) {
                console.error('Fehler beim Lesen der Sitzungen:', e);
                return {};
            }
        }

        function saveActiveSessions(sessions) {
            localStorage.setItem('adminActiveSessions', JSON.stringify(sessions));
        }

        function isUserOnline(sessions, username) {
            const arr = sessions[username];
            return Array.isArray(arr) && arr.length > 0;
        }

        function registerThisTab() {
            if (!currentUser || !currentUser.username) return;
            let tabId = sessionStorage.getItem('adminTabId');
            if (!tabId) {
                tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).slice(2);
                sessionStorage.setItem('adminTabId', tabId);
            }
            const sessions = getActiveSessions();
            if (!sessions[currentUser.username]) sessions[currentUser.username] = [];
            if (!sessions[currentUser.username].includes(tabId)) {
                sessions[currentUser.username].push(tabId);
            }
            saveActiveSessions(sessions);
        }

        function unregisterThisTab() {
            const tabId = sessionStorage.getItem('adminTabId');
            if (!tabId || !currentUser || !currentUser.username) return;
            const sessions = getActiveSessions();
            const arr = sessions[currentUser.username];
            if (Array.isArray(arr)) {
                sessions[currentUser.username] = arr.filter(id => id !== tabId);
                if (sessions[currentUser.username].length === 0) delete sessions[currentUser.username];
            }
            saveActiveSessions(sessions);
        }

        async function hashString(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        const usersListEl = document.getElementById('usersListBody') || document.getElementById('usersList');
        const userErrorEl = document.getElementById('userErrorMessage');
        const usersCountPill = document.getElementById('usersCountPill');

        function renderUsersList() {
            if (!usersListEl) return;

            const users = getStoredUsers();
            const sessions = getActiveSessions();

            if (!users.length) {
                usersListEl.innerHTML = '<p style="text-align: center; color: var(--text-gray);">Noch keine Benutzer angelegt</p>';
                if (usersCountPill) {
                    usersCountPill.textContent = '0 Benutzer';
                }
                return;
            }

            const rows = users.map(user => {
                const perms = user.permissions || {};
                const permBadges = [];
                if (perms.gallery) permBadges.push('<span class="user-perm-badge">Galerie</span>');
                if (perms.news) permBadges.push('<span class="user-perm-badge">News</span>');
                if (perms.messages) permBadges.push('<span class="user-perm-badge">Nachrichten</span>');
                if (perms.order) permBadges.push('<span class="user-perm-badge">Reihenfolge</span>');
                if (perms.users) permBadges.push('<span class="user-perm-badge">Benutzer</span>');

                const isLoggedIn = isUserOnline(sessions, user.username);
                const nameClass = isLoggedIn ? 'user-online' : 'user-offline';
                const statusLabel = isLoggedIn ? 'Eingeloggt' : 'Nicht eingeloggt';
                const statusDetail = isLoggedIn ? 'Online' : 'Offline';
                const statusBadgeClass = isLoggedIn ? 'user-status-badge logged-in' : 'user-status-badge logged-out';

                return `
                    <div class="user-row animate-user-row">
                        <div class="user-main">
                            <div class="user-name ${nameClass}">${user.username}</div>
                            <div class="user-meta">
                                <span class="${statusBadgeClass}">${statusLabel}</span> ¬∑ ${statusDetail}<br>
                                Angelegt: ${user.createdAt ? new Date(user.createdAt).toLocaleString('de-DE') : '-'}
                            </div>
                        </div>
                        <div class="user-perms">
                            ${permBadges.join('') || '<span class="user-perm-badge">Keine speziellen Rechte</span>'}
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-edit" onclick="editUser('${user.id}')">Bearbeiten</button>
                            <button class="btn btn-danger" onclick="deleteUser('${user.id}')">L√∂schen</button>
                            ${isLoggedIn ? `<button class="btn btn-secondary" onclick="forceLogoutUser('${user.username}')" title="Benutzer aus allen Sitzungen abmelden">Abmelden</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            usersListEl.innerHTML = rows;

            if (usersCountPill) {
                usersCountPill.textContent = users.length === 1 ? '1 Benutzer' : users.length + ' Benutzer';
            }
        }

        function resetUserForm() {
            document.getElementById('editingUserId').value = '';
            document.getElementById('userLogin').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPasswordConfirm').value = '';
            document.getElementById('permGallery').checked = false;
            document.getElementById('permNews').checked = false;
            document.getElementById('permMessages').checked = false;
            document.getElementById('permOrder').checked = false;
            document.getElementById('permUsers').checked = false;
            if (userErrorEl) {
                userErrorEl.textContent = '';
                userErrorEl.classList.remove('show');
            }
            const cancelBtn = document.getElementById('cancelUserEditBtn');
            if (cancelBtn) cancelBtn.style.display = 'none';
        }

        async function loadUsers() {
            renderUsersList();
        }

        if (document.getElementById('saveUserBtn')) {
            document.getElementById('saveUserBtn').addEventListener('click', async () => {
                if (!hasPermission('users')) {
                    return;
                }

                const editingId = document.getElementById('editingUserId').value;
                const username = document.getElementById('userLogin').value.trim();
                const password = document.getElementById('userPassword').value;
                const passwordConfirm = document.getElementById('userPasswordConfirm').value;

                const perms = {
                    gallery: document.getElementById('permGallery').checked,
                    news: document.getElementById('permNews').checked,
                    messages: document.getElementById('permMessages').checked,
                    order: document.getElementById('permOrder').checked,
                    users: document.getElementById('permUsers').checked
                };

                if (!username) {
                    userErrorEl.textContent = 'Benutzername darf nicht leer sein.';
                    userErrorEl.classList.add('show');
                    return;
                }

                const users = getStoredUsers();

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–Ω–∞
                const existingWithSameName = users.find(u => u.username === username && u.id !== editingId);
                if (existingWithSameName) {
                    userErrorEl.textContent = 'Ein Benutzer mit diesem Namen existiert bereits.';
                    userErrorEl.classList.add('show');
                    return;
                }

                let passwordHash = null;

                if (!editingId) {
                    // Neuer Benutzer ‚Äì –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
                    if (!password || password.length < 6) {
                        userErrorEl.textContent = 'Passwort muss mindestens 6 Zeichen enthalten.';
                        userErrorEl.classList.add('show');
                        return;
                    }
                    if (password !== passwordConfirm) {
                        userErrorEl.textContent = 'Passw√∂rter stimmen nicht √ºberein.';
                        userErrorEl.classList.add('show');
                        return;
                    }
                    passwordHash = await hashString(password);

                    users.push({
                        id: Date.now().toString(),
                        username,
                        passwordHash,
                        permissions: perms,
                        createdAt: new Date().toISOString()
                    });
                } else {
                    // Bearbeiten bestehenden Benutzers
                    const idx = users.findIndex(u => u.id === editingId);
                    if (idx === -1) return;

                    // –ï—Å–ª–∏ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è –ø—É—Å—Ç—ã–µ ‚Äì –ø–∞—Ä–æ–ª—å –Ω–µ –º–µ–Ω—è–µ–º
                    if (password || passwordConfirm) {
                        if (password.length < 6) {
                            userErrorEl.textContent = 'Passwort muss mindestens 6 Zeichen enthalten.';
                            userErrorEl.classList.add('show');
                            return;
                        }
                        if (password !== passwordConfirm) {
                            userErrorEl.textContent = 'Passw√∂rter stimmen nicht √ºberein.';
                            userErrorEl.classList.add('show');
                            return;
                        }
                        passwordHash = await hashString(password);
                        users[idx].passwordHash = passwordHash;
                    }

                    users[idx].username = username;
                    users[idx].permissions = perms;
                }

                saveStoredUsers(users);
                resetUserForm();
                renderUsersList();
            });
        }

        if (document.getElementById('cancelUserEditBtn')) {
            document.getElementById('cancelUserEditBtn').addEventListener('click', () => {
                resetUserForm();
            });
        }

        window.editUser = function(id) {
            if (!hasPermission('users')) return;

            const users = getStoredUsers();
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('editingUserId').value = user.id;
            document.getElementById('userLogin').value = user.username;
            document.getElementById('userPassword').value = '';
            document.getElementById('userPasswordConfirm').value = '';

            const perms = user.permissions || {};
            document.getElementById('permGallery').checked = !!perms.gallery;
            document.getElementById('permNews').checked = !!perms.news;
            document.getElementById('permMessages').checked = !!perms.messages;
            document.getElementById('permOrder').checked = !!perms.order;
            document.getElementById('permUsers').checked = !!perms.users;

            const cancelBtn = document.getElementById('cancelUserEditBtn');
            if (cancelBtn) cancelBtn.style.display = 'inline-flex';

            if (userErrorEl) {
                userErrorEl.textContent = '';
                userErrorEl.classList.remove('show');
            }
        };

        window.deleteUser = function(id) {
            if (!hasPermission('users')) return;

            const users = getStoredUsers();
            const user = users.find(u => u.id === id);
            if (!user) return;

            if (!confirm(`Benutzer "${user.username}" wirklich l√∂schen?`)) {
                return;
            }

            const updated = users.filter(u => u.id !== id);
            saveStoredUsers(updated);
            renderUsersList();
        };

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ª–æ–≥–∞—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ —Å–ø–∏—Å–∫–∞) ‚Äî –≤—ã–±—Ä–æ—Å–∏—Ç –µ–≥–æ —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
        window.forceLogoutUser = function(username) {
            if (!hasPermission('users')) return;
            if (!username) return;

            const sessions = getActiveSessions();
            if (!isUserOnline(sessions, username)) return;

            if (!confirm(`Benutzer "${username}" wirklich abmelden?`)) {
                return;
            }

            delete sessions[username];
            saveActiveSessions(sessions);
            localStorage.setItem('adminKickedOut', username);
            renderUsersList();
        };

        // Benutzerliste beim Laden der Seite initialisieren (falls Tab sichtbar)
        if (hasPermission('users')) {
            loadUsers();
        }

        // ‚Äî‚Äî‚Äî Statistik (moderne Grafiken + Animationen) ‚Äî‚Äî‚Äî
        let statsCharts = {};
        const CHART_COLORS = {
            red: 'rgba(220, 20, 60, 0.9)',
            redLight: 'rgba(220, 20, 60, 0.45)',
            green: 'rgba(34, 197, 94, 0.9)',
            greenLight: 'rgba(34, 197, 94, 0.45)',
            blue: 'rgba(59, 130, 246, 0.9)',
            blueLight: 'rgba(59, 130, 246, 0.45)',
            gray: 'rgba(148, 163, 184, 0.75)'
        };

        const CHART_DEFAULTS = {
            animation: { duration: 1200 },
            animations: {
                y: { type: 'number', easing: 'easeOutQuart', duration: 1200 },
                x: { type: 'number', easing: 'easeOutQuart', duration: 1200 },
                radius: { type: 'number', easing: 'easeOutQuart', duration: 1200 }
            },
            layout: { padding: { top: 8, right: 12, bottom: 8, left: 12 } },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 11 }, color: '#64748b', maxRotation: 45 }
                },
                y: {
                    grid: { color: 'rgba(0,0,0,0.06)' },
                    ticks: { font: { size: 11 }, color: '#64748b', stepSize: 1 }
                }
            },
            plugins: {
                legend: { labels: { font: { size: 12 }, color: '#334155', usePointStyle: true } }
            }
        };

        function loadStats() {
            if (!document.getElementById('statsTab') || !document.getElementById('statsTab').classList.contains('active')) return;

            let visitStats = {};
            try {
                visitStats = JSON.parse(localStorage.getItem('siteVisitStats') || '{}');
            } catch (e) {}
            const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
            const news = JSON.parse(localStorage.getItem('news') || '[]');
            const galleryImages = JSON.parse(localStorage.getItem('galleryImages') || '[]');
            const users = getStoredUsers();
            const sessions = getActiveSessions();
            const onlineCount = Object.keys(sessions).reduce((sum, u) => sum + (Array.isArray(sessions[u]) ? sessions[u].length : 0), 0);

            const visitsTotal = Object.values(visitStats).reduce((a, b) => a + b, 0);
            document.getElementById('statVisitsTotal').textContent = visitsTotal;
            document.getElementById('statMessagesTotal').textContent = messages.length;
            document.getElementById('statNewsTotal').textContent = news.length;
            document.getElementById('statGalleryTotal').textContent = galleryImages.length;
            document.getElementById('statUsersTotal').textContent = users.length + 1;

            function lastNDays(n) {
                const out = [];
                for (let i = n - 1; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    out.push(d.toISOString().slice(0, 10));
                }
                return out;
            }

            const days14 = lastNDays(14);
            const visitLabels = days14.map(d => {
                const t = new Date(d);
                return t.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            });
            const visitData = days14.map(d => visitStats[d] || 0);

            if (statsCharts.visits) statsCharts.visits.destroy();
            const visitsCtx = document.getElementById('chartVisits').getContext('2d');
            statsCharts.visits = new Chart(visitsCtx, {
                type: 'bar',
                data: {
                    labels: visitLabels,
                    datasets: [{
                        label: 'Besuche',
                        data: visitData,
                        backgroundColor: function(ctx) {
                            const chart = ctx.chart;
                            const area = chart.chartArea;
                            if (!area) return CHART_COLORS.redLight;
                            const g = visitsCtx.createLinearGradient(0, area.bottom, 0, area.top);
                            g.addColorStop(0, 'rgba(220, 20, 60, 0.25)');
                            g.addColorStop(1, 'rgba(220, 20, 60, 0.75)');
                            return g;
                        },
                        borderColor: 'rgba(220, 20, 60, 0.9)',
                        borderWidth: 1,
                        borderRadius: { topLeft: 6, topRight: 6 },
                        borderSkipped: false,
                        barPercentage: 0.7,
                        categoryPercentage: 0.85
                    }]
                },
                options: {
                    ...CHART_DEFAULTS,
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        ...CHART_DEFAULTS.scales,
                        y: { ...CHART_DEFAULTS.scales.y, beginAtZero: true }
                    },
                    animation: CHART_DEFAULTS.animation,
                    animations: CHART_DEFAULTS.animations
                }
            });

            const newCount = messages.filter(m => m.status === 'new').length;
            const completedCount = messages.filter(m => m.status === 'completed').length;
            if (statsCharts.messages) statsCharts.messages.destroy();
            statsCharts.messages = new Chart(document.getElementById('chartMessages'), {
                type: 'doughnut',
                data: {
                    labels: ['Neu', 'Erledigt'],
                    datasets: [{
                        data: [newCount, completedCount],
                        backgroundColor: [CHART_COLORS.blue, CHART_COLORS.green],
                        borderWidth: 2,
                        borderColor: '#fff',
                        hoverBorderWidth: 3,
                        hoverOffset: 8,
                        borderRadius: 4,
                        spacing: 3
                    }]
                },
                options: {
                    ...CHART_DEFAULTS,
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '58%',
                    plugins: {
                        legend: { position: 'bottom', labels: { ...CHART_DEFAULTS.plugins.legend.labels, padding: 16 } }
                    },
                    animation: { duration: 1400 },
                    animations: {
                        radius: { type: 'number', easing: 'easeOutQuart', duration: 1400 }
                    }
                }
            });

            const messagesByDay = {};
            days14.forEach(d => { messagesByDay[d] = 0; });
            messages.forEach(m => {
                if (m.date) {
                    const d = m.date.slice(0, 10);
                    if (messagesByDay[d] !== undefined) messagesByDay[d]++;
                }
            });
            const msgDayLabels = days14.map(d => new Date(d).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }));
            const msgDayData = days14.map(d => messagesByDay[d] || 0);
            if (statsCharts.messagesByDay) statsCharts.messagesByDay.destroy();
            const msgDayCtx = document.getElementById('chartMessagesByDay').getContext('2d');
            statsCharts.messagesByDay = new Chart(msgDayCtx, {
                type: 'bar',
                data: {
                    labels: msgDayLabels,
                    datasets: [{
                        label: 'Nachrichten',
                        data: msgDayData,
                        backgroundColor: function(ctx) {
                            const chart = ctx.chart;
                            const area = chart.chartArea;
                            if (!area) return CHART_COLORS.blueLight;
                            const g = msgDayCtx.createLinearGradient(0, area.bottom, 0, area.top);
                            g.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                            g.addColorStop(1, 'rgba(59, 130, 246, 0.7)');
                            return g;
                        },
                        borderColor: 'rgba(59, 130, 246, 0.9)',
                        borderWidth: 1,
                        borderRadius: { topLeft: 6, topRight: 6 },
                        borderSkipped: false,
                        barPercentage: 0.7,
                        categoryPercentage: 0.85
                    }]
                },
                options: {
                    ...CHART_DEFAULTS,
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        ...CHART_DEFAULTS.scales,
                        y: { ...CHART_DEFAULTS.scales.y, beginAtZero: true }
                    },
                    animation: CHART_DEFAULTS.animation,
                    animations: CHART_DEFAULTS.animations
                }
            });

            const totalUsers = users.length + 1;
            if (statsCharts.users) statsCharts.users.destroy();
            statsCharts.users = new Chart(document.getElementById('chartUsers'), {
                type: 'bar',
                data: {
                    labels: ['Benutzer gesamt', 'Online (offene Sitzungen)'],
                    datasets: [{
                        label: 'Anzahl',
                        data: [totalUsers, onlineCount],
                        backgroundColor: [
                            'rgba(148, 163, 184, 0.6)',
                            'rgba(34, 197, 94, 0.7)'
                        ],
                        borderWidth: 1,
                        borderColor: ['rgba(148, 163, 184, 0.9)', 'rgba(34, 197, 94, 0.9)'],
                        borderRadius: { topRight: 6, bottomRight: 6 },
                        borderSkipped: false,
                        barThickness: 32,
                        barPercentage: 0.8
                    }]
                },
                options: {
                    ...CHART_DEFAULTS,
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ...CHART_DEFAULTS.scales.x, beginAtZero: true },
                        y: { grid: { display: false }, ticks: { ...CHART_DEFAULTS.scales.x.ticks } }
                    },
                    animation: CHART_DEFAULTS.animation,
                    animations: CHART_DEFAULTS.animations
                }
            });

            const monthCount = {};
            news.forEach(n => {
                if (n.date) {
                    const key = n.date.slice(0, 7);
                    monthCount[key] = (monthCount[key] || 0) + 1;
                }
            });
            const sortedMonths = Object.keys(monthCount).sort();
            const newsLabels = sortedMonths.length ? sortedMonths.map(m => {
                const [y, mo] = m.split('-');
                return new Date(parseInt(y), parseInt(mo) - 1, 1).toLocaleDateString('de-DE', { month: 'short', year: '2-digit' });
            }) : ['‚Äî'];
            const newsData = sortedMonths.length ? sortedMonths.map(m => monthCount[m]) : [0];
            if (statsCharts.news) statsCharts.news.destroy();
            const newsCtx = document.getElementById('chartNews').getContext('2d');
            statsCharts.news = new Chart(newsCtx, {
                type: 'bar',
                data: {
                    labels: newsLabels,
                    datasets: [{
                        label: 'Neuigkeiten',
                        data: newsData,
                        backgroundColor: function(ctx) {
                            const chart = ctx.chart;
                            const area = chart.chartArea;
                            if (!area) return CHART_COLORS.redLight;
                            const g = newsCtx.createLinearGradient(0, area.bottom, 0, area.top);
                            g.addColorStop(0, 'rgba(220, 20, 60, 0.2)');
                            g.addColorStop(1, 'rgba(220, 20, 60, 0.75)');
                            return g;
                        },
                        borderColor: 'rgba(220, 20, 60, 0.9)',
                        borderWidth: 1,
                        borderRadius: { topLeft: 6, topRight: 6 },
                        borderSkipped: false,
                        barPercentage: 0.7,
                        categoryPercentage: 0.85
                    }]
                },
                options: {
                    ...CHART_DEFAULTS,
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        ...CHART_DEFAULTS.scales,
                        y: { ...CHART_DEFAULTS.scales.y, beginAtZero: true }
                    },
                    animation: CHART_DEFAULTS.animation,
                    animations: CHART_DEFAULTS.animations
                }
            });
        }

        // –†–µ–∞–∫—Ü–∏—è –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π (–∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–æ–∫ / –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ª–æ–≥–∞—É—Ç)
        window.addEventListener('storage', (event) => {
            if (event.key === 'adminKickedOut') {
                const kicked = event.newValue;
                if (kicked && currentUser && currentUser.username === kicked) {
                    unregisterThisTab();
                    sessionStorage.removeItem('adminTabId');
                    sessionStorage.removeItem('adminLoggedIn');
                    sessionStorage.removeItem('currentUser');
                    localStorage.removeItem('adminStoredSession');
                    localStorage.removeItem('adminKickedOut');
                    window.location.href = 'admin.html';
                    return;
                }
            }
            if (event.key === 'adminActiveSessions') {
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–ª–∏ –∏–ª–∏ –∑–∞–∫—Ä—ã–ª–∏ –≤—Å–µ –µ–≥–æ –≤–∫–ª–∞–¥–∫–∏
                if (currentUser && currentUser.username) {
                    const sessions = getActiveSessions();
                    if (!isUserOnline(sessions, currentUser.username)) {
                        sessionStorage.removeItem('adminTabId');
                        sessionStorage.removeItem('adminLoggedIn');
                        sessionStorage.removeItem('currentUser');
                        localStorage.removeItem('adminStoredSession');
                        window.location.href = 'admin.html';
                        return;
                    }
                }
                if (hasPermission('users')) {
                    renderUsersList();
                }
            }
        });
    </script>
</body>
</html>
